<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Quiz Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Inter", sans-serif;
            background: #0F172A;
            color: #F1F5F9;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        .header h1 { font-size: 24px; font-weight: 700; color: #10B981; }
        .back-btn {
            padding: 10px 20px;
            background: #334155;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .back-btn:hover { background: #475569; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1E293B;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; color: #6366F1; margin-bottom: 5px; }
        .stat-label { color: #94A3B8; font-size: 14px; }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .student-card {
            background: #1E293B;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .student-card.active { border-color: #10B981; }
        .student-card.completed { border-color: #6366F1; opacity: 0.8; }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .student-name { font-weight: 600; font-size: 16px; }
        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #94A3B8;
        }
        .status-dot.online { background: #10B981; box-shadow: 0 0 10px #10B981; }
        
        .progress-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #10B981;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .student-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #94A3B8;
        }
        .score-badge {
            background: rgba(99, 102, 241, 0.1);
            color: #6366F1;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px;
            color: #94A3B8;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            animation: fadeInUp 0.8s ease-out;
        }

        .stat-card {
            animation: fadeInUp 0.8s ease-out backwards;
        }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.5s ease-in-out; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üì° Live Quiz Monitor</h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="endQuiz()" class="back-btn" style="background: #EF4444; border: none; cursor: pointer;">End Quiz</button>
            <a href="teacher_dashboard.html" class="back-btn">Exit Monitoring</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalStudents">0</div>
            <div class="stat-label">Active Students</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalSubmissions">0</div>
            <div class="stat-label">Questions Answered</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgProgress">0%</div>
            <div class="stat-label">Avg. Progress</div>
        </div>
    </div>

    <!-- Main Content Layout -->
    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px;">
        
        <!-- Left: Student Grid -->
        <div>
            <h2 style="margin-bottom: 20px; color: #94A3B8;">Student Progress</h2>
            <div id="studentsGrid" class="students-grid">
                <div class="empty-state">
                    <h3>Waiting for students to join...</h3>
                    <p>Students will appear here as they join the quiz.</p>
                </div>
            </div>
        </div>

        <!-- Right: Malpractice Log -->
        <div>
            <h2 style="margin-bottom: 20px; color: #EF4444;">Malpractice Log ‚ö†Ô∏è</h2>
            <div id="malpracticeLog" style="background: #1E293B; border: 1px solid #334155; border-radius: 12px; padding: 15px; height: 500px; overflow-y: auto;">
                <div style="color: #64748B; font-style: italic;">No incidents recorded yet.</div>
            </div>
        </div>

    </div>

    <!-- Hidden audio element if needed -->
</div>

<script>
    const socket = io(CONFIG.SOCKET_URL);
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('quizId');
    
    // State
    const students = {}; // { userid: { name, progress, score, totalQuestions } }
    let totalQuestions = 0;

    // Initialize
    socket.on('connect', () => {
        console.log('Connected to monitor');
        socket.emit('monitor_join');
    });

    socket.on('monitor_init', (data) => {
        if (!data.active) {
            document.querySelector('.empty-state h3').textContent = "No Active Quiz";
            document.querySelector('.empty-state p').textContent = "Please return to dashboard and start a quiz.";
            return;
        }

        // Set total questions if available from quiz data
        if (data.quiz && data.quiz.questions) {
            totalQuestions = data.quiz.questions.length;
        }

        // Populate students
        data.students.forEach(s => {
             students[s.userid] = {
                name: s.userid,
                progress: 0, // Calculated in updateUI if needed or we can compute
                score: 0,
                answers: s.answersCount,
                answeredQuestions: new Set(), // We don't have the exact IDs here without more complex logic, but count is sufficient for progress bar
                status: s.status
             };
        });
        
        updateUI();
    });

    // Listen for student join
    socket.on('student_joined', (data) => {
        if (!students[data.userid]) {
            students[data.userid] = {
                name: data.userid,
                progress: 0,
                score: 0,
                answers: data.answersCount || 0, // Use server-provided count
                answeredQuestions: new Set(), // We might not have the set, but count is key
                status: 'online'
            };
            updateUI();
        } else {
             // If student already exists (maybe offline -> online), update status and count
             students[data.userid].status = 'online';
             if (data.answersCount > students[data.userid].answers) {
                 students[data.userid].answers = data.answersCount;
             }
             updateUI();
        }
    });

    // Listen for answers
    socket.on('new_answer', (data) => {
        // data = { userid, questionIndex, answer }
        if (!students[data.userid]) {
            // If we missed the join event
            students[data.userid] = {
                name: data.userid,
                progress: 0,
                score: 0,
                answers: 0,
                answeredQuestions: new Set(),
                status: 'online'
            };
        }

        const student = students[data.userid];
        
        // Initialize Set if it doesn't exist (for existing students object)
        if (!student.answeredQuestions) {
            student.answeredQuestions = new Set();
        }

        student.answeredQuestions.add(data.questionIndex);
        student.answers = student.answeredQuestions.size;
        
        updateUI();
    });

    socket.on('quiz_completed', (data) => {
        // data = { score, totalMarks, resultId } - wait, this event is sent to the STUDENT socket.
        // The teacher socket doesn't receive 'quiz_completed' for a specific student unless we broadcast it.
        // But 'new_answer' is broadcasted.
        // Let's rely on 'new_answer' for live updates.
    });

    socket.on('quiz_ended', () => {
        alert("Quiz has been ended successfully.");
        window.location.href = 'teacher_dashboard.html';
    });

    function endQuiz() {
        if (confirm("Are you sure you want to end this quiz? Students will not be able to submit further answers.")) {
            socket.emit('end_quiz');
        }
    }

    function updateUI() {
        const grid = document.getElementById('studentsGrid');
        const studentIds = Object.keys(students);
        
        if (studentIds.length === 0) return;

        // Update stats
        document.getElementById('totalStudents').textContent = studentIds.length;
        const totalAns = Object.values(students).reduce((acc, s) => acc + s.answers, 0);
        document.getElementById('totalSubmissions').textContent = totalAns;

        // Render cards
        grid.innerHTML = studentIds.map((id, index) => {
            const s = students[id];
            return `
                <div class="student-card active" style="animation: fadeInUp 0.5s ease-out backwards; animation-delay: ${index * 0.1}s">
                    <div class="student-header">
                        <span class="student-name">üë§ ${s.name}</span>
                        <div class="status-dot ${s.status}"></div>
                    </div>
                    <div class="student-stats">
                        <span>Questions Attempted</span>
                        <span class="score-badge">${s.answers}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(s.answers * 10, 100)}%"></div>
                    </div>
                    <div class="student-stats">
                        <small>Last active: Just now</small>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---------------------------------------------
    // Malpractice Logging Logic
    // ---------------------------------------------
    const malpracticeLog = [];

    socket.on("malpractice_alert", (data) => {
        // data: { userid, type, timestamp }
        malpracticeLog.unshift(data);
        if (malpracticeLog.length > 50) malpracticeLog.pop();
        
        updateMalpracticeUI();
        playSoundAlert();
        
        // Visual indicator on student card
        const card = document.querySelector(`.student-card[data-userid="${data.userid}"]`);
        if (card) {
            card.style.borderColor = "#EF4444";
            card.classList.add("shake");
            setTimeout(() => card.classList.remove("shake"), 500);
        }
    });

    function updateMalpracticeUI() {
        const logContainer = document.getElementById('malpracticeLog');
        if (!logContainer) return; // Guard clause if UI not inserted yet

        if (malpracticeLog.length === 0) {
            logContainer.innerHTML = '<div style="color: #64748B; font-style: italic;">No incidents recorded yet.</div>';
            return;
        }

        logContainer.innerHTML = malpracticeLog.map(log => `
            <div class="log-entry" style="border-left: 3px solid #EF4444; background: rgba(239, 68, 68, 0.1); padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <strong style="color: #F87171;">${log.userid}</strong>
                    <span style="font-size: 12px; color: #94A3B8;">${new Date(log.timestamp).toLocaleTimeString()}</span>
                </div>
                <div style="color: #E2E8F0; font-size: 14px;">${log.type}</div>
            </div>
        `).join('');
    }

    function playSoundAlert() {
        // Optional: Simple beep or visual flash
        const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'); // Placeholder or empty
        // Since browsers block auto-play, we often skip this or require interaction first.
    }

    // Initial fetch of quiz details to get total questions (optional but good)
    async function fetchQuizDetails() {
        if (!quizId) return;
        try {
            // We need an endpoint to get single quiz, or just use the list
            // For now, we'll just adapt dynamically
        } catch(e) { console.error(e); }
    }

    fetchQuizDetails();

</script>
</body>
</html>
