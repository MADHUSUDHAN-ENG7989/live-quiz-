<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Question Arena ‚ö°</title>
    <script src="config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1; /* Indigo */
            --primary-glow: rgba(99, 102, 241, 0.4);
            --secondary: #EC4899; /* Pink */
            --accent: #8B5CF6; /* Violet */
            --dark-bg: #0B0F19; /* Deep Space */
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #F8FAFC;
            --text-muted: #94A3B8;
            --success: #10B981;
            --error: #EF4444;
            --font-main: 'Outfit', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }

        body {
            background: var(--dark-bg);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 40%);
            z-index: -1;
            pointer-events: none;
        }

        /* Main Layout */
        .arena-wrapper {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        /* Center Stage */
        .stage-area {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* Glass Header */
        header {
            width: 100%;
            max-width: 1000px;
            padding: 16px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .logo-branding {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Score Pills */
        .score-pill {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 8px 20px;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        .score-pill:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(255, 255, 255, 0.15); }
        
        .score-label { 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            color: var(--text-muted); 
            font-weight: 600;
        }
        
        .score-value { 
            font-size: 18px; 
            font-weight: 800; 
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-exit {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-exit:hover { background: rgba(239, 68, 68, 0.2); transform: translateY(-1px); }

        /* Content Sections */
        .view-section {
            width: 100%;
            max-width: 800px;
            display: none; /* Toggled via JS */
            flex-direction: column;
            align-items: center;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .view-section.active { display: flex; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Glass Card Container */
        .arena-card {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        /* Floating Orbs for Aesthetics */
        .arena-card::before {
            content: ''; position: absolute; top: -50px; left: -50px; width: 150px; height: 150px;
            background: var(--primary); opacity: 0.15; filter: blur(60px); border-radius: 50%; pointer-events: none;
        }
        .arena-card::after {
            content: ''; position: absolute; bottom: -50px; right: -50px; width: 150px; height: 150px;
            background: var(--secondary); opacity: 0.15; filter: blur(60px); border-radius: 50%; pointer-events: none;
        }

        /* Inputs */
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 700;
        }

        .arena-input {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.2s;
            outline: none;
        }
        .arena-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }

        /* Buttons */
        .btn-primary-action {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        .btn-primary-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }
        .btn-primary-action::after {
            content:''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), transparent);
            opacity: 0; transition: opacity 0.3s;
        }
        .btn-primary-action:hover::after { opacity: 1; }

        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        
        .option-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 24px;
            border-radius: 16px;
            color: var(--text-main);
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .option-letter {
            width: 32px; height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-muted);
        }

        .option-btn:hover:not(:disabled) {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .option-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        .option-btn.selected .option-letter { background: white; color: var(--primary); }

        .option-btn.correct { background: var(--success) !important; border-color: var(--success); }
        .option-btn.wrong { background: var(--error) !important; border-color: var(--error); opacity: 0.6; }
        
        /* Leaderboard Sidebar */
        .sidebar {
            width: 320px;
            height: 100%;
            background: rgba(15, 15, 20, 0.95);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: absolute;
            right: 0; top: 0;
            z-index: 50;
        }
        /* Mobile vs Desktop */
        @media (min-width: 1200px) {
            .sidebar { position: relative; transform: translateX(0); background: transparent; backdrop-filter: none; width: 300px; border-left: 1px solid rgba(255,255,255,0.05); }
        }
        .sidebar.active { transform: translateX(0); box-shadow: -20px 0 50px rgba(0,0,0,0.5); }

        .lb-header {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            border-bottom: 2px solid rgba(255,255,255,0.05);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .lb-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        .lb-list::-webkit-scrollbar { width: 4px; }
        .lb-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        .lb-item {
            background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 2px solid transparent;
        }
        .lb-item.top-3 { border-left-color: #FCD34D; background: linear-gradient(90deg, rgba(252, 211, 77, 0.1), transparent); }
        
        .lb-rank { font-weight: 700; color: var(--text-muted); width: 25px; }
        .lb-name { font-weight: 500; font-size: 14px; }
        .lb-points { font-weight: 700; color: var(--primary); font-size: 13px; background: rgba(99, 102, 241, 0.1); padding: 4px 10px; border-radius: 6px; }

        /* Timer Bar */
        .timer-progress {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, #10B981, #F59E0B, #EF4444);
            transform-origin: left; transform: scaleX(0);
        }
        .timer-progress.active { transition-timing-function: linear !important; transform: scaleX(1); }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

    </style>
</head>
<body>
    <div class="ambient-bg"></div>

    <div class="arena-wrapper">
        <!-- Main Stage -->
        <main class="stage-area">
            <header>
                <div class="logo-branding">
                    <span class="logo-icon">‚ö°</span>
                    <span class="logo-text">Question Arena</span>
                </div>
                
                <div style="display: flex; gap: 20px;">
                    <div class="score-pill">
                        <span class="score-label">Teacher</span>
                        <span class="score-value" id="teacherScoreDisplay">0</span>
                    </div>
                    <div class="score-pill">
                        <span class="score-label">My Score</span>
                        <span class="score-value" id="studentScoreDisplay">0</span>
                    </div>
                </div>

                <button onclick="exitArena()" class="btn-exit">EXIT ARENA</button>
            </header>

            <div id="connectionWarning" style="color: var(--error); background: rgba(239, 68, 68, 0.1); padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: none; font-weight: 600;">
                ‚ö† Connection Lost. Trying to reconnect...
            </div>

            <!-- TEACHER VIEW (Control Center) -->
            <section id="teacherView" class="view-section">
                <div class="arena-card">
                    <h2 style="margin-bottom: 30px; font-weight: 800; font-size: 24px;">üöÄ Launch Control</h2>
                    
                    <div class="input-group">
                        <label>Question Text</label>
                        <input type="text" id="qText" class="arena-input" placeholder="Enter your question here...">
                    </div>

                    <div class="options-grid" style="margin: 20px 0;">
                        <input type="text" id="optA" class="arena-input" placeholder="Option A">
                        <input type="text" id="optB" class="arena-input" placeholder="Option B">
                        <input type="text" id="optC" class="arena-input" placeholder="Option C">
                        <input type="text" id="optD" class="arena-input" placeholder="Option D">
                    </div>

                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div class="input-group" style="flex: 1;">
                            <label>Correct Answer</label>
                            <select id="correctOpt" class="arena-input">
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>
                        </div>
                        <div class="input-group" style="flex: 1;">
                            <label>Timer: <span id="timeVal" style="color: var(--primary);">30</span>s</label>
                            <input type="range" id="timeLimit" min="5" max="60" value="30" 
                                   style="width: 100%; margin-top: 15px; accent-color: var(--primary);"
                                   oninput="document.getElementById('timeVal').innerText = this.value">
                        </div>
                    </div>

                    <button class="btn-primary-action" onclick="launchQuestion()">
                         Fire Question üî•
                    </button>
                    
                    <div id="launchStatus" style="text-align: center; margin-top: 15px; color: var(--success); height: 20px; font-weight: 600;"></div>
                    
                    <button onclick="resetScores()" style="display: block; margin: 30px auto 0; background: transparent; border: none; color: var(--text-muted); cursor: pointer; text-decoration: underline; font-size: 13px;">
                        Reset All Scores & Data
                    </button>
                </div>
            </section>

            <!-- STUDENT VIEW (Waiting) -->
            <section id="studentWaitingView" class="view-section">
                <div style="text-align: center; padding: 60px;">
                    <div style="width: 100px; height: 100px; margin: 0 auto 30px; border-radius: 50%; background: radial-gradient(circle, var(--primary) 0%, transparent 70%); animation: pulse 2s infinite;"></div>
                    <h2 style="font-size: 28px; font-weight: 700;">Waiting for Signal...</h2>
                    <p style="color: var(--text-muted); margin-top: 10px; font-size: 18px;">Eyes on the screen. Next round incoming.</p>
                </div>
            </section>

            <!-- STUDENT VIEW (Question) -->
            <section id="studentQuestionView" class="view-section">
                <div class="arena-card" style="padding: 0;">
                    <div class="timer-progress" id="timerBar"></div>
                    
                    <div style="padding: 40px;">
                         <!-- Result Overlay (Embedded) -->
                        <div id="resultOverlay" style="display: none; text-align: center; margin-bottom: 30px; animation: slideUp 0.3s;">
                            <h2 id="resTitle" style="font-size: 36px; margin-bottom: 10px;"></h2>
                            <p id="resMsg" style="color: var(--text-muted);"></p>
                        </div>

                        <h2 class="question-text" id="displayQuestion" style="font-size: 24px; font-weight: 700; margin-bottom: 30px; line-height: 1.4;"></h2>
                        
                        <div class="options-grid">
                            <button class="option-btn" onclick="submitAnswer('A')" id="btnA">
                                <span class="option-letter">A</span> <span class="opt-text">Option A</span>
                            </button>
                            <button class="option-btn" onclick="submitAnswer('B')" id="btnB">
                                <span class="option-letter">B</span> <span class="opt-text">Option B</span>
                            </button>
                            <button class="option-btn" onclick="submitAnswer('C')" id="btnC">
                                <span class="option-letter">C</span> <span class="opt-text">Option C</span>
                            </button>
                            <button class="option-btn" onclick="submitAnswer('D')" id="btnD">
                                <span class="option-letter">D</span> <span class="opt-text">Option D</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Sidebar (Leaderboard) -->
        <aside class="sidebar" id="lbSidebar">
            <div class="lb-header">üèÜ Live Rankings</div>
            <div id="lbList" class="lb-list">
                <div style="text-align: center; color: var(--text-muted); font-size: 13px; padding-top: 20px;">
                    Waiting for updates...
                </div>
            </div>
             <!-- Close button for mobile -->
            <button onclick="toggleMobileLeaderboard()" class="btn-exit" style="margin-top: 20px; display: none;" id="closeLbBtn">Close Panel</button>
        </aside>
    </div>

    <!-- Mobile Toggle -->
    <button onclick="toggleMobileLeaderboard()" style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); border: none; color: white; font-size: 24px; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5); z-index: 100; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        üèÜ
    </button>

    <script>
        const SOCKET_URL = CONFIG.SOCKET_URL;
        let socket;
        let currentUser;
        let currentRole;
        let currentQuestion;
        let timerInterval;

        document.addEventListener('DOMContentLoaded', checkAuth);

        function checkAuth() {
            const token = localStorage.getItem("quizToken");
            if (!token) { location.href = 'index.html'; return; }
            
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                
                currentUser = JSON.parse(jsonPayload);
                currentRole = currentUser.role;

                setupUI();
                initSocket();
            } catch (e) { console.error(e); location.href = 'index.html'; }
        }

        function setupUI() {
            if (currentRole === 'teacher') document.getElementById('teacherView').classList.add('active');
            else document.getElementById('studentWaitingView').classList.add('active');
        }

        function initSocket() {
            socket = io(SOCKET_URL);
            
            socket.on('connect', () => {
                document.getElementById('connectionWarning').style.display = 'none';
                socket.emit('join_arena', { userid: currentUser.userid, role: currentRole });
            });
            
            socket.on('disconnect', () => {
                document.getElementById('connectionWarning').style.display = 'block';
            });

            socket.on('score_update', updateScores);
            socket.on('arena_global_score_update', (d) => {
                 document.getElementById('teacherScoreDisplay').textContent = d.teacherScore;
            });

            socket.on('arena_leaderboard_update', updateLeaderboard);

            if (currentRole === 'student') {
                socket.on('arena_new_question', startQuestion);
                socket.on('arena_answer_result', showResult);
            }
        }

        // --- TEACHER ---
        function launchQuestion() {
            const q = document.getElementById('qText').value;
            const a = document.getElementById('optA').value;
            const b = document.getElementById('optB').value;
            const c = document.getElementById('optC').value;
            const d = document.getElementById('optD').value;
            const correct = document.getElementById('correctOpt').value;
            const time = parseInt(document.getElementById('timeLimit').value);

            if(!q || !a || !b) { alert("Fill required fields"); return; }

            socket.emit('arena_post_question', {
                question: q,
                options: { A: a, B: b, C: c, D: d },
                correctOption: correct,
                timeLimit: time
            });

            const status = document.getElementById('launchStatus');
            status.textContent = "Question Active! ‚è≥";
            setTimeout(() => status.textContent = "", 3000);
        }

        function resetScores() {
            if(confirm("Reset Everything?")) socket.emit('arena_reset_scores');
        }

        // --- STUDENT ---
        function startQuestion(qData) {
            currentQuestion = qData;
            
            // Reset View
            document.getElementById('studentWaitingView').classList.remove('active');
            document.getElementById('studentQuestionView').classList.add('active');
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('displayQuestion').textContent = qData.question;
            
            ['A','B','C','D'].forEach(opt => {
                const btn = document.getElementById('btn'+opt);
                // Updated to target specific span
                const txt = btn.querySelector('.opt-text');
                if(txt) txt.textContent = qData.options[opt];
                else btn.textContent = qData.options[opt]; // Fallback
                
                btn.disabled = false;
                // Reset classes but keep option-btn
                btn.className = 'option-btn'; 
            });

            // Start Timer
            const bar = document.getElementById('timerBar');
            bar.classList.remove('active');
             // Trigger reflow
            void bar.offsetWidth;
            
            // CSS Animation
            bar.style.transition = `transform ${qData.timeLimit}s linear`;
            bar.classList.add('active');
            // bar starts at scale(0) so removing active resets it ? No, wait. 
            // My CSS says active -> scaleX(1). So it grows.
            // But usually timers shrink. 
            // Let's make it shrink? Or Grow? 
            // Old code: transform 0 -> 1? 
            // Let's stick to GROW for now as per my CSS.
            
            // Auto-submit logic
            clearTimeout(timerInterval);
            timerInterval = setTimeout(() => {
                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            }, qData.timeLimit * 1000);
        }

        function submitAnswer(opt) {
            clearTimeout(timerInterval);
            
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            document.getElementById('btn' + opt).classList.add('selected');

            socket.emit('arena_submit_answer', {
                userid: currentUser.userid,
                answer: opt,
                correctOption: currentQuestion.correctOption
            });
        }

        function showResult(res) {
            const title = document.getElementById('resTitle');
            const msg = document.getElementById('resMsg');
            const overlay = document.getElementById('resultOverlay');

            document.getElementById('btn' + res.correctOption).classList.add('correct');
            if(!res.correct) document.querySelector('.selected')?.classList.add('wrong');

            if(res.correct) {
                title.textContent = "CORRECT! üéâ";
                title.style.color = "#10B981";
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else {
                title.textContent = "WRONG üíÄ";
                title.style.color = "#EF4444";
            }

            overlay.style.display = 'block';
            updateScores({teacherScore: res.teacherScore, studentScore: res.newScore});

            // Auto return to waiting
            setTimeout(() => {
                if(document.getElementById('studentQuestionView').classList.contains('active')){
                    document.getElementById('studentQuestionView').classList.remove('active');
                    document.getElementById('studentWaitingView').classList.add('active');
                    // Reset timer bar
                    document.getElementById('timerBar').classList.remove('active');
                }
            }, 4000);
        }

        // --- COMMON ---
        function updateScores(d) {
            if(d.teacherScore !== undefined) document.getElementById('teacherScoreDisplay').textContent = d.teacherScore;
            if(currentRole === 'student' && d.studentScore !== undefined) document.getElementById('studentScoreDisplay').textContent = d.studentScore;
        }

        function updateLeaderboard(list) {
            const container = document.getElementById('lbList');
            container.innerHTML = list.map((u, i) => `
                <div class="lb-item ${i < 3 ? 'top-3' : ''}">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span class="lb-rank">${i+1}</span>
                        <span class="lb-name">${u.userid}</span>
                    </div>
                    <span class="lb-points">${u.score} pts</span>
                </div>
            `).join('');
        }

        function toggleMobileLeaderboard() {
            const sb = document.getElementById('lbSidebar');
            sb.classList.toggle('active');
            // Toggle close button visibility for mobile
            const btn = document.getElementById('closeLbBtn');
            btn.style.display = sb.classList.contains('active') ? 'block' : 'none';
        }

        function exitArena() {
            location.href = currentRole === 'teacher' ? 'teacher_dashboard.html' : 'student_dashboard.html';
        }

    </script>
</body>
</html>
