<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Analytics</title>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Inter", sans-serif;
            background: #0F172A;
            min-height: 100vh;
            padding: 20px;
            color: #F1F5F9;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .subtitle {
            color: #94A3B8;
            font-size: 16px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .stat-label {
            color: #94A3B8;
            font-size: 14px;
        }
        .stat-card.primary .stat-value { color: #6366F1; }
        .stat-card.success .stat-value { color: #10B981; }
        .stat-card.warning .stat-value { color: #F59E0B; }
        .stat-card.info .stat-value { color: #06B6D4; }
        
        /* Quiz Results Table */
        .results-section {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 30px;
        }
        .results-section h2 {
            font-size: 24px;
            margin-bottom: 24px;
        }
        .quiz-item {
            background: rgba(51, 65, 85, 0.4);
            padding: 20px;
            margin-bottom: 16px;
            border-radius: 12px;
            border: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .quiz-item:hover {
            border-color: #6366F1;
            transform: translateX(4px);
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .quiz-title {
            font-size: 18px;
            font-weight: 600;
            color: #F1F5F9;
        }
        .quiz-score {
            font-size: 24px;
            font-weight: bold;
            color: #10B981;
        }
        .quiz-meta {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #94A3B8;
        }
        .quiz-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #06B6D4);
            transition: width 0.3s ease;
        }
        
        /* Question Details (Expandable) */
        .question-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #334155;
        }
        .question-details.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 1000px; }
        }
        .question-item {
            background: rgba(15, 23, 42, 0.5);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 3px solid transparent;
        }
        .question-item.correct { border-left-color: #10B981; }
        .question-item.incorrect { border-left-color: #EF4444; }
        
        .question-text {
            font-weight: 500;
            margin-bottom: 8px;
        }
        .answer-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #94A3B8;
            margin-top: 8px;
        }
        .answer-row .correct-ans { color: #10B981; }
        .answer-row .wrong-ans { color: #EF4444; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748B;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        /* Button */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üìä Performance Analytics</h1>
        <p class="subtitle" id="userInfo">Loading your performance data...</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-value" id="totalQuizzes">0</div>
            <div class="stat-label">Total Quizzes</div>
        </div>
        <div class="stat-card success">
            <div class="stat-value" id="avgScore">0%</div>
            <div class="stat-label">Average Score</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="avgAccuracy">0%</div>
            <div class="stat-label">Average Accuracy</div>
        </div>
        <div class="stat-card info">
            <div class="stat-value" id="totalTime">0m</div>
            <div class="stat-label">Total Time Spent</div>
        </div>
    </div>

    <!-- Quiz Results -->
    <div class="results-section">
        <h2>Quiz History</h2>
        <div id="quizResults">
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <p>No quiz attempts yet. Start taking quizzes to see your analytics!</p>
                <a href="quiz_list.html" class="btn">Browse Quizzes</a>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = CONFIG.API_BASE_URL;
const userid = localStorage.getItem("quizUser");

if (!userid) {
    alert("Please login first");
    window.location.href = "index.html";
}

async function loadAnalytics() {
    try {
        const response = await fetch(`${API_URL}/api/analytics/${userid}`);
        const results = await response.json();
        
        if (results.length === 0) {
            return;
        }
        
        // Update stats
        document.getElementById('userInfo').textContent = `Performance summary for ${userid}`;
        document.getElementById('totalQuizzes').textContent = results.length;
        
        // Calculate averages
        const totalMarks = results.reduce((sum, r) => sum + r.totalMarks, 0);
        const earnedMarks = results.reduce((sum, r) => sum + r.score, 0);
        const avgScore = ((earnedMarks / totalMarks) * 100).toFixed(1);
        document.getElementById('avgScore').textContent = avgScore + '%';
        document.getElementById('avgAccuracy').textContent = avgScore + '%';
        
        // Calculate total time
        const totalSeconds = results.reduce((sum, r) => sum + (r.totalTimeTaken || 0), 0);
        const minutes = Math.floor(totalSeconds / 60);
        document.getElementById('totalTime').textContent = minutes + 'm';
        
        // Render quiz results
        renderQuizResults(results);
        
    } catch (error) {
        console.error("Error loading analytics:", error);
        alert("Failed to load analytics. Please try again.");
    }
}

function renderQuizResults(results) {
    const container = document.getElementById('quizResults');
    
    container.innerHTML = results.map((result, index) => {
        const accuracy = ((result.score / result.totalMarks) * 100).toFixed(1);
        const date = new Date(result.timestamp).toLocaleString();
        const totalTime = result.totalTimeTaken || 0;
        const avgTime = totalTime > 0 ? (totalTime / result.answers.length).toFixed(0) : 0;
        
        return `
            <div class="quiz-item" onclick="toggleDetails(${index})">
                <div class="quiz-header">
                    <div class="quiz-title">${result.quizTitle}</div>
                    <div class="quiz-score">${result.score}/${result.totalMarks}</div>
                </div>
                
                <div class="quiz-meta">
                    <span>üìÖ ${date}</span>
                    <span>üéØ ${accuracy}% Accuracy</span>
                    <span>‚è±Ô∏è ${totalTime}s Total | ${avgTime}s/Q Avg</span>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${accuracy}%"></div>
                </div>
                
                <div class="question-details" id="details-${index}">
                    ${renderQuestionDetails(result.answers)}
                </div>
            </div>
        `;
    }).join('');
}

function renderQuestionDetails(answers) {
    return answers.map((ans, idx) => `
        <div class="question-item ${ans.isCorrect ? 'correct' : 'incorrect'}">
            <div class="question-text">
                ${idx + 1}. ${ans.questionText}
            </div>
            <div class="answer-row">
                <div>
                    <strong>Your Answer:</strong> 
                    <span class="${ans.isCorrect ? 'correct-ans' : 'wrong-ans'}">${ans.userAnswer || 'Not answered'}</span>
                </div>
                <div>
                    <strong>Correct:</strong> 
                    <span class="correct-ans">${ans.correctAnswer}</span>
                </div>
            </div>
            <div class="answer-row">
                <div>
                    <strong>Marks:</strong> ${ans.marksEarned}/${ans.marksEarned + (ans.isCorrect ? 0 : (ans.marksEarned || 1))}
                </div>
                <div>
                    <strong>Time:</strong> ${ans.timeTaken || 0}s / ${ans.timeLimit || 30}s
                </div>
            </div>
        </div>
    `).join('');
}

function toggleDetails(index) {
    const details = document.getElementById(`details-${index}`);
    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
    } else {
        // Close all other expanded details
        document.querySelectorAll('.question-details.expanded').forEach(el => {
            el.classList.remove('expanded');
        });
        details.classList.add('expanded');
    }
}

// Load analytics on page load
loadAnalytics();
</script>

</body>
</html>
